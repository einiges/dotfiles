# vim:ft=zsh

# Create tmp directory and change into it

local -A opts
zparseopts -D -K -A opts p: I h

if [[ -v opts[-h] ]]; then
	cat <<- EOF >&2
		Change into new temporary directory and
		optionally run a command to prepare it.

		    $0 [-qh] [-I replace-str] [--] [CMD [ARG...]]

		CMD runs between the creation of the temporary
		directory and changing into it. The temporary
		directory can be queried by setting the -I argument.

		Examples:
		    ct
		    ct -I @ cp -r dir/* @
	EOF
	return 0
fi

local td=$(mktemp -d)

if (( ARGC )); then
	local -a cmd
	cmd=( "$@" )
	if [[ -v opts[-I] ]]; then
		cmd=( "${cmd[@]//${opts[-I]}/$td}" )
	fi
	"${cmd[@]}"
	local ec=$?
	if (( ec )); then
		rmdir "$td"
		return $ec
	fi
fi

if [[ ! -v opts[-q] ]]; then
	printf "%s\n" "$td"
fi

builtin cd "$td"

